{{ define "pagerduty.description" }}
[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .CommonLabels.alertname }}{{ if .CommonLabels.job }} for {{ .CommonLabels.job }}{{ end }}{{ if .CommonLabels.instance }} on {{ .CommonLabels.instance }}{{ end }}
{{ end }}

{{ define "pagerduty.severity" }}
{{- if eq .Status "firing" -}}
  {{- if eq .CommonLabels.severity "critical" -}}
    critical
  {{- else if eq .CommonLabels.severity "warning" -}}
    warning
  {{- else if eq .CommonLabels.severity "info" -}}
    info
  {{- else -}}
    warning
  {{- end -}}
{{- else -}}
  info
{{- end -}}
{{ end }}

{{ define "pagerduty.details" }}
{
  "summary": "{{ template "pagerduty.description" . }}",
  "severity": "{{ template "pagerduty.severity" . }}",
  "source": "Alertmanager",
  "timestamp": "{{ .StartsAt }}",
  "component": "{{ .CommonLabels.job }}",
  "class": "{{ .CommonLabels.alertname }}",
  "group": "{{ .CommonLabels.cluster }}{{ if .CommonLabels.namespace }}/{{ .CommonLabels.namespace }}{{ end }}",
  "custom_details": {
    "status": "{{ .Status | toUpper }}",
    "starts_at": "{{ .StartsAt }}",
    {{- if eq .Status "resolved" }}
    "ends_at": "{{ .EndsAt }}",
    {{- end }}
    "num_firing": {{ .Alerts.Firing | len }},
    "num_resolved": {{ .Alerts.Resolved | len }},
    "external_url": "{{ .ExternalURL }}",
    
    "common_labels": {
      {{- range $key, $value := .CommonLabels }}
      "{{ $key }}": "{{ $value }}",
      {{- end }}
      "_separator": ""
    },
    "common_annotations": {
      {{- range $key, $value := .CommonAnnotations }}
      "{{ $key }}": "{{ $value }}",
      {{- end }}
      "_separator": ""
    },
    
    "alerts": [
    {{- range $index, $alert := .Alerts }}
      {
        "status": "{{ $alert.Status }}",
        "labels": {
          {{- range $key, $value := $alert.Labels }}
          "{{ $key }}": "{{ $value }}",
          {{- end }}
          "_separator": ""
        },
        "annotations": {
          {{- range $key, $value := $alert.Annotations }}
          "{{ $key }}": "{{ $value }}",
          {{- end }}
          "_separator": ""
        },
        "starts_at": "{{ $alert.StartsAt }}",
        {{- if eq $alert.Status "resolved" }}
        "ends_at": "{{ $alert.EndsAt }}",
        {{- end }}
        "generator_url": "{{ $alert.GeneratorURL }}",
        "fingerprint": "{{ $alert.Fingerprint }}"
      }{{ if not (last $index $.Alerts) }},{{ end }}
    {{- end }}
    ]
  }
}
{{ end }}

{{ define "pagerduty.actionItem" }}
{{ end }}

{{ define "pagerduty.default.description" }}[{{ .Status | toUpper }}{{ if eq .Status "firing" }}:{{ .Alerts.Firing | len }}{{ end }}] {{ .GroupLabels.SortedPairs.Values | join " " }} {{ if gt (len .CommonLabels) (len .GroupLabels) }}({{ with .CommonLabels.Remove .GroupLabels.Names }}{{ .Values | join " " }}{{ end }}){{ end }}{{ end }}

{{ define "pagerduty.default.client" }}{{ template "__alertmanager" . }}{{ end }}
{{ define "pagerduty.default.clientURL" }}{{ template "__alertmanagerURL" . }}{{ end }}

{{ define "pagerduty.default.instances" }}
{{ range .Alerts }}
  {
    "severity": {{ if eq .Labels.severity "critical" }}"critical"{{ else if eq .Labels.severity "warning" }}"warning"{{ else }}"info"{{ end }},
    "component": "{{ .Labels.instance }}",
    "class": "{{ .Labels.alertname }}",
    "custom_details": {
      "alert_name": "{{ .Labels.alertname }}",
      "instance": "{{ .Labels.instance }}",
      "description": "{{ .Annotations.description }}",
      "summary": "{{ .Annotations.summary }}"
      {{ range .Labels.SortedPairs }},
      "{{ .Name }}": "{{ .Value }}"
      {{ end }}
    }
  }{{ if not .Last }},{{ end }}
{{ end }}
{{ end }}

{{ define "pagerduty.default.message" }}
{
  "routing_key": "{{ .PagerDutyKey }}",
  "event_action": "{{ if eq .Status "firing" }}trigger{{ else }}resolve{{ end }}",
  "dedup_key": "{{ if eq .Status "firing" }}{{ .GroupKey }}{{ else }}{{ .GroupKey }}{{ end }}",
  "payload": {
    "summary": "{{ template "pagerduty.default.description" . }}",
    "source": "{{ template "pagerduty.default.client" . }}",
    "severity": "{{ if eq .CommonLabels.severity "critical" }}critical{{ else if eq .CommonLabels.severity "warning" }}warning{{ else }}info{{ end }}",
    "component": "Alertmanager",
    "group": "{{ .GroupLabels.alertname }}",
    "class": "{{ .CommonLabels.alertname }}",
    "custom_details": {
      "firing": "{{ .Alerts.Firing | len }}",
      "resolved": "{{ .Alerts.Resolved | len }}",
      "num_firing": "{{ .Alerts.Firing | len }}"
    }
  },
  "client": "{{ template "pagerduty.default.client" . }}",
  "client_url": "{{ template "pagerduty.default.clientURL" . }}",
  "links": [
    {
      "href": "{{ template "__alertmanagerURL" . }}",
      "text": "View in Alertmanager"
    }
  ]
}
{{ end }}

